---
title: "project"
author: "Erin Lyons, Yujian Tang, Norma Techarukpong, Ryan Thomas, Jason Yu"
date: "April 3, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(MASS)
library(ggplot2)
library(purrr)
library(leaps)
library(glmnet)
```

#Data Cleaning
```{r}
#Uploading Dataset
CPS.data <- read.csv("Chicago_Public_Schools_-_Progress_Report_Cards__2011-2012_.csv")

#Cleaning Data
CPS.data$Link <- NULL
CPS.data$Phone.Number <- NULL
CPS.data$State <- NULL
CPS.data$Street.Address <- NULL
CPS.data$Location <- NULL
CPS.data$City <- NULL
CPS.data$RCDTS.Code <- NULL
```

```{r}
#Removing NDA values from variables and changing the values to NA
for(i in names(CPS.data)) {
  for(j in 1:nrow(CPS.data)) {
    if(isTRUE(CPS.data[j,i] == "NDA")) { CPS.data[j, i] = NA}
  }
}

#View
head(CPS.data)
```
```{r}
#Data that only describes the numeric variables
numeric.data <- CPS.data[, map_lgl(CPS.data, is.numeric)]
head(numeric.data)
```


#Ryan's Section
Ideas:

- Other Variables connection to classificaiton
- Are there certain ways to categorize elementary middle and high school?

```{r}
#Safety and Parents
ggplot(CPS.data) +
  geom_point(aes(x = Safety.Score, y = Parent.Environment.Score, col = Adequate.Yearly.Progress.Made.))

#Attendance
ggplot(filter(CPS.data, Average.Teacher.Attendance != 0)) +
  geom_point(aes(x = Average.Student.Attendance, y = Average.Teacher.Attendance, col = Adequate.Yearly.Progress.Made.))

#
```
1st graph: High safety scores indicate higher progress.

2nd graph: Most progress happened when attendance was high for both parties. 

```{r}
head(numeric.data)
```

#Numerical Analysis
```{r}
#Correlation of all Variables
correlation.matrix <- cor(numeric.data, use = "complete.obs")
correlation.dataset <- as.data.frame(correlation.matrix)
most.correlation <- which(abs(correlation.matrix) < 1 & abs(correlation.matrix) > .70)

rows.list <- list()
columns.list <- list()
j <- 1
#For Loop for finding maximum correlations
for(i in most.correlation) {
  #Correlation
  row <- ceiling(i/ncol(numeric.data))
  column <- ifelse(i%%ncol(numeric.data) == 0, ncol(numeric.data), i%%ncol(numeric.data))
  rows.list[[j]] <- rownames(correlation.dataset[row,])
  columns.list[[j]] <- names(correlation.dataset)[column]
  j = j+1
}

row.column.names = cbind(rows.list, columns.list)

#New Dataframe To hold Rows/ Columns
row.column.dataframe <- data.frame(
  row = NULL,
  column = NULL
)
#putting values in dataframe
for(i in 1:length(rows.list)) {
  newRow = data.frame(row = rows.list[[i]], column = columns.list[[i]])
  row.column.dataframe <- rbind(row.column.dataframe, newRow)
}

#Changing variable types to character
row.column.dataframe$row <- as.character(row.column.dataframe$row)
row.column.dataframe$column <- as.character(row.column.dataframe$column)

#Removing Duplicates
for (i in 1:nrow(row.column.dataframe))
{
    row.column.dataframe[i, ] = sort(row.column.dataframe[i, ])
}
row.column.dataframe <- row.column.dataframe[!duplicated(row.column.dataframe),]

#Viewing Dataframe of Variables with the most Correlation
row.column.dataframe
```



```{r}
#For Loop For Creating Scatterplots of data with the Greatest Correlation
for(i in 1:nrow(row.column.dataframe)) {
  #Extract column and row variable
  row <- row.column.dataframe[[i, 1]]
  column <- row.column.dataframe[[i, 2]]
  #Plot
  print(ggplot(CPS.data) +
    geom_point(aes_string(x = row, y = column), color = "blue4") +
    geom_smooth(aes_string(x = row, y = column)) +
    theme_minimal() +
    ggtitle("Correlations"))
}
```

##How well can we predict student attendance?
Goal - determine best model between lasso regression, ridge regression, and least squares regression with variable selection.


```{r}
#Data frame with no NA values
no.na <- na.omit(numeric.data)
test.set <- sample_n(no.na, 100)
train.set <- anti_join(no.na, test.set)

#Least Squares Model
fullLinMod.SA <- lm(Average.Student.Attendance~., data = train.set)

#Stepwise
backwards <- step(fullLinMod.SA, direction = "backward", trace = FALSE)
forwards <- step(fullLinMod.SA, direction = "backward", trace = FALSE)

#Lasso Regression
modMatrix <- model.matrix(Average.Student.Attendance~., data= train.set)
lassoMod = cv.glmnet(modMatrix, y = train.set$Average.Student.Attendance, alpha = 1, nfolds = 5)

#Ridge Regression
ridgeMod = cv.glmnet(modMatrix, y = train.set$Average.Student.Attendance, alpha = 0, nfolds = 5)

#predictions
full.predictions <- predict(fullLinMod.SA, test.set)
backwards.predictions <- predict(backwards, test.set)
forwards.predictions <- predict(forwards, test.set)
lasso.predictions <- predict(lassoMod, test.set, type = "response")



MSE.full = mean((full.predictions - test.set$Average.Student.Attendance)^2)
MSE.back = mean((backwards.predictions - test.set$Average.Student.Attendance)^2)
MSE.for = mean((forwards.predictions - test.set$Average.Student.Attendance)^2)


MSE.full
MSE.back
MSE.for
```



##Classification for School Grade-level
```{r}
#Function that removes collinearity for data
remove.collinearity <- function(data, c) {
  #Correlation of all Variables
  correlation.matrix <- cor(data, use = "complete.obs")
  correlation.dataset <- as.data.frame(correlation.matrix)
  most.correlation <- which(abs(correlation.matrix) < 1 & abs(correlation.matrix) > c)

  rows.list <- list()
  columns.list <- list()
  j <- 1
  #For Loop for finding maximum correlations
  for(i in most.correlation) {
    #Correlation
    row <- ceiling(i/ncol(data))
    column <- ifelse(i%%ncol(data) == 0, ncol(data), i%%ncol(data))
    rows.list[[j]] <- rownames(correlation.dataset[row,])
    columns.list[[j]] <- names(correlation.dataset)[column]
    j = j+1
  }

  row.column.names = cbind(rows.list, columns.list)

  #New Dataframe To hold Rows/ Columns
  row.column.dataframe <- data.frame(
    row = NULL,
    column = NULL
  )
  #putting values in dataframe
  for(i in 1:length(rows.list)) {
    newRow = data.frame(row = rows.list[[i]], column = columns.list[[i]])
    row.column.dataframe <- rbind(row.column.dataframe, newRow)
  }

  #Changing variable types to character
  row.column.dataframe$row <- as.character(row.column.dataframe$row)
  row.column.dataframe$column <- as.character(row.column.dataframe$column)

  #Removing Duplicates
  for (i in 1:nrow(row.column.dataframe))
  {
      row.column.dataframe[i, ] = sort(row.column.dataframe[i, ])
  }
  row.column.dataframe <- row.column.dataframe[!duplicated(row.column.dataframe),]

  #Dataframe of Variables with the most Correlation
  table <- row.column.dataframe
  
  #creates new dataframe without correlations above c
  new.data = data
  for(i in 1:nrow(table)) {
    new.data[,table[i,2]] <- NULL
  }
  return(new.data)
}
```

```{r}
newdata = numeric.data %>%
  select_if(Negate(is.integer)) %>%
  select_if(is.numeric)

newdata <- remove.collinearity(newdata, .1)
newdata
newdata <- cbind(numeric.data, CPS.data$Elementary..Middle..or.High.School)
newdata$Elementary..Middle..or.High.School <- newdata$`CPS.data$Elementary..Middle..or.High.School`
newdata$`CPS.data$Elementary..Middle..or.High.School`<- NULL

ldaMod <- lda(Elementary..Middle..or.High.School~., data = newdata)
```




```{r}
# Jason's section
```